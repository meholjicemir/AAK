var DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];var SCOPES="profile email https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/drive.readonly";var authorizeButton=document.getElementById('authorize-button');var signoutButton=document.getElementById('signout-button');function handleClientLoad(){gapi.load('client:auth2',initClient)}
function initClient(){gapi.client.init({discoveryDocs:DISCOVERY_DOCS,clientId:Google_ClientId,scope:SCOPES}).then(function(){gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());authorizeButton.onclick=handleAuthClick;signoutButton.onclick=handleSignoutClick})}
function updateSigninStatus(isSignedIn){if(isSignedIn){authorizeButton.style.display='none';signoutButton.style.display='block';var currUsr=gapi.auth2.getAuthInstance().currentUser;var email=findVal(currUsr,"email");var token=findVal(currUsr,"id_token");var accessToken=findVal(currUsr,"access_token");ValidateUser(email,token,accessToken)}else{authorizeButton.style.display='block';signoutButton.style.display='none'}}
function handleAuthClick(event){gapi.auth2.getAuthInstance().signIn()}
function handleSignoutClick(event){gapi.auth2.getAuthInstance().signOut()}
function CreateGoogleCalendarEvent(radnja,callback){var summary=radnja.VrstaRadnjeName.substring(0,radnja.VrstaRadnjeName.length-1)+" ("+CurrentCase.Naziv+")";var description=radnja.Biljeske;var _start=new Date(radnja.DatumRadnje);var _end=new Date(radnja.DatumRadnje);_end.setHours(new Date(radnja.DatumRadnje).getHours()+1);var resource={"summary":summary,"description":description,"location":"","start":{"dateTime":_start.toISOString(),"timeZone":"Europe/Sarajevo"},"end":{"dateTime":_end.toISOString(),"timeZone":"Europe/Sarajevo"}};var request=gapi.client.calendar.events.insert({'calendarId':GoogleCalendarId,'resource':resource});request.execute(function(resp){radnja.GoogleEventId=resp.id;callback(radnja)})}
function DeleteGoogleCalendarEvent(eventId){var request=gapi.client.calendar.events.delete({"calendarId":GoogleCalendarId,"eventId":eventId});request.execute()}
function DownloadFileFromGoogleDrive(fileId,fileName){var oReq=new XMLHttpRequest();oReq.open("GET","https://www.googleapis.com/drive/v3/files/"+fileId+"?alt=media",!0);oReq.setRequestHeader("Authorization","Bearer "+CurrentUser.AccessToken);oReq.responseType="arraybuffer";oReq.onload=function(oEvent){if(oReq.status==403){window.open("https://drive.google.com/drive/u/0/folders/"+fileId,"_blank")}
else{var arrayBuffer=oReq.response;var a=document.createElement("a");document.body.appendChild(a);a.style="display: none";var blob=new Blob([arrayBuffer],{type:"octet/stream"});url=window.URL.createObjectURL(blob);a.href=url;a.download=fileName;a.click();window.URL.revokeObjectURL(url)}};oReq.send()}
function OpenPicker(){gapi.load('picker',{'callback':onPickerApiLoad})}
function createPicker(){var view=new google.picker.DocsView();view.setParent(GoogleDriveRootFolderId);view.setIncludeFolders(!0);view.setSelectFolderEnabled(!0);if(pickerApiLoaded&&CurrentUser.AccessToken){var picker=new google.picker.PickerBuilder().addView(view).setOAuthToken(CurrentUser.AccessToken).setCallback(pickerCallback).build();picker.setVisible(!0)}}
function pickerCallback(data){var url='nothing';if(data[google.picker.Response.ACTION]==google.picker.Action.PICKED){var doc=data[google.picker.Response.DOCUMENTS][0];url=doc[google.picker.Document.URL]}
var message='You picked: '+url;if(url!="nothing"){CurrentGoogleDocSelection.DocName=doc.name;CurrentGoogleDocSelection.DocId=doc.id;switch(CurrentGoogleDocSelection.Tip){case "radnja":$("#aCase_Radnja_DocumentLink").html(doc.name);$("#aCase_Radnja_DocumentLink").attr("href",url);$("#aCase_Radnja_DocumentLink").attr("google_drive_doc_id",doc.id);$("#btnCase_Radnja_RemoveGoogleDoc").show();break;case "dokument":$("#aCase_Document_DocumentLink").html(doc.name);$("#aCase_Document_DocumentLink").attr("href",url);$("#aCase_Document_DocumentLink").attr("google_drive_doc_id",doc.id);$("#btnCase_Document_RemoveGoogleDoc").show();if($("#ddlCase_Document_TipDokumenta").val()!=-1&&$("#aCase_Document_DocumentLink").html()!="")
$("#btnAppendDocumentToCase").removeAttr("disabled");break}}}
function onPickerApiLoad(){pickerApiLoaded=!0;createPicker()}
function findVal(object,key){var value;Object.keys(object).some(function(k){if(k===key||(key==="email"&&object[k]!=undefined&&object[k]!=null&&object[k].toString().endsWith("@gmail.com"))){value=object[k];return!0}
if(object[k]&&typeof object[k]==='object'){value=findVal(object[k],key);return value!==undefined}});return value}